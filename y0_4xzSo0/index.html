<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title> KVM实验（一） | quansen88.cn</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kill0es.github.io/favicon.ico?v=1623993914396">
<link rel="stylesheet" href="https://kill0es.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="KVM实验（一）
参考：https://www.cnblogs.com/wn1m/p/11281576.html
一、验证是否开启虚拟化
[root@node1 ~]# grep -E &quot;vmx|svm&quot; /proc/c..." />
    <meta name="keywords" content="kvm" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kill0es.github.io">
        <img src="https://kill0es.github.io/images/avatar.png?v=1623993914396" class="site-logo">
        <h1 class="site-title">quansen88.cn</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      linux运维
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/kill0es/" target="_blank">kill0es</a> | <a class="rss" href="https://kill0es.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title"> KVM实验（一）</h2>
            <div class="post-date">2021-05-04</div>
            
              <div class="feature-container" style="background-image: url('https://www.linux.org/images/logo.png')">
              </div>
            
            <div class="post-content" v-pre>
              <h1 id="kvm实验一">KVM实验（一）</h1>
<p>参考：https://www.cnblogs.com/wn1m/p/11281576.html</p>
<h3 id="一-验证是否开启虚拟化">一、验证是否开启虚拟化</h3>
<pre><code class="language-bash">[root@node1 ~]# grep -E &quot;vmx|svm&quot; /proc/cpuinfo | wc -l
4
</code></pre>
<h3 id="二-安装工具">二、安装工具</h3>
<p><strong>qemu-kvm(kvm在用户空间的管理工具),libvirt(一个服务，其下组件可用来管理kvm虚拟机)</strong></p>
<pre><code class="language-bash">[root@node1 ~]# yum install qemu-kvm libvirt -y
</code></pre>
<p><strong>libvirt安装完后会创建virbr0网桥</strong></p>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191113192136.png" alt="" loading="lazy"></figure>
<h3 id="三-相关命令">三、相关命令</h3>
<pre><code class="language-bash">libvirt
使用最多的KVM虚拟化管理工具和应用程序接口，即通过libvirt调用KVM创建虚拟机，libvirt是KVM通用的访问API，其不但能管理KVM，还能管理VMware、Xen、Hyper-V、virtualBox等虚拟化方案。

virsh：
是一个常用的管理KVM虚拟化的命令行工具，常用语管理运行在单个宿主机上的虚拟机，virsh是一个使用C语言编写调用libvirt API的虚拟化管理命令行工具。

virt-manager：
virt-manager是一个虚拟化管理图形软件，其底层也是调用libvirt API来完成对虚拟机的操作，包括虚拟机的创建、删除、启动、停止以及一些简单的监控功能等。

openstack：
openstack是一个开源的虚拟化编排工具，常用于构建大规模的虚拟化环境，用语管理成千上万虚拟机的创建、启动、删除等整个生命周期。
</code></pre>
<h3 id="四-启动服务">四、启动服务</h3>
<pre><code class="language-bash">[root@node1 ~]# systemctl start libvirtd &amp;&amp; systemctl enable libvirtd
</code></pre>
<h3 id="五-libvirt0-client已经安装virt-install安装下管理虚拟机的">五、libvirt0-client已经安装，virt-install安装下，管理虚拟机的</h3>
<pre><code class="language-bash">[root@node1 ~]# yum install virt-install -y
</code></pre>
<h3 id="六-安装vncserver待会儿要用好像不需要"><s>六、安装vncserver待会儿要用（好像不需要）</s></h3>
<pre><code class="language-bash">[root@node1 ~]# yum install tigervnc-server -y
</code></pre>
<h3 id="七-创建自己的网桥br0不用自动创建的">七、创建自己的网桥br0，不用自动创建的</h3>
<pre><code class="language-bash">[root@node1 network-scripts]# cat ifcfg-br0 
# Generated by dracut initrd
NAME=&quot;br0&quot;
DEVICE=br0
ONBOOT=yes
BOOTPROTO=static
TYPE=Bridge
IPADDR=172.18.3.138
NETMASK=255.255.0.0
GATEWAY=172.18.0.1
DNS1=114.114.114.114
[root@node1 network-scripts]# cat  ifcfg-eth0 
# Generated by dracut initrd
NAME=&quot;eth0&quot;
ONBOOT=yes
BOOTPROTO=static
TYPE=Ethernet
BRIDGE=br0
DNS1=114.114.114.114
</code></pre>
<pre><code class="language-bash">[root@node1 network-scripts]# systemctl restart network
</code></pre>
<p><strong>删除之前的网桥</strong></p>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191113193558.png" alt="" loading="lazy"></figure>
<pre><code class="language-bash">[root@node1 network-scripts]# brctl show
bridge name	bridge id		STP enabled	interfaces
br0		8000.000c297afd2e	no		eth0
virbr0		8000.5254002fd1b3	yes		virbr0-nic
[root@node1 network-scripts]# ip link set virbr0 down
[root@node1 network-scripts]# brctl delbr virbr0
[root@node1 network-scripts]# brctl show
bridge name	bridge id		STP enabled	interfaces
br0		8000.000c297afd2e	no		eth0
[root@node1 network-scripts]# ip link delete virbr0-nic		#也删一下
</code></pre>
<figure data-type="image" tabindex="3"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191113193929.png" alt="" loading="lazy"></figure>
<h3 id="八-下载镜像">八、下载镜像</h3>
<pre><code class="language-bash">[root@node1 ~]# mkdir /data/image -p
[root@node1 ~]# cd /data/image/
[root@node1 image]# wget http://cloud-images.ubuntu.com/daily/server/bionic/current/bionic-server-cloudimg-arm64.img
</code></pre>
<h3 id="九-创建10g磁盘空间">九、创建10G磁盘空间</h3>
<pre><code class="language-bash">[root@node1 image]# qemu-img create -f qcow2  /data/machine/centos7-1 10G
Formatting '/data/machine/centos7-1', fmt=qcow2 size=10737418240 encryption=off cluster_size=65536 lazy_refcounts=off
</code></pre>
<h3 id="十-创建虚拟机">十、创建虚拟机</h3>
<pre><code class="language-bash">[root@node1 image]# virt-install \
 --name centos7-1 \
 --memory 512 \
 --vcpus 1 \
 --virt-type kvm \
 --cdrom /data/image/CentOS-7-x86_64-Minimal-1908.iso \
 --disk /data/machine/centos7-1 \
 --network bridge=br0 \
 --graphics vnc,listen=0.0.0.0 \
 --noautoconsole
</code></pre>
<h3 id="十一-vnc连接">十一、vnc连接</h3>
<pre><code class="language-bash">[root@node1 data]# virsh list
 Id    Name                           State
----------------------------------------------------
 1     centos7-1                      running

[root@node1 data]# ss -ltn
State      Recv-Q Send-Q                      Local Address:Port                                     Peer Address:Port              
LISTEN     0      1                                       *:5900                                                *:*        
</code></pre>
<figure data-type="image" tabindex="4"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191113202034.png" alt="" loading="lazy"></figure>
<p><strong>失败了，连不上，网上也找不到资料，都是virt-manager管理的，之前我用ubuntu是可以的</strong></p>
<p>换了vnc可以连上了：https://www.realvnc.com/download/file/viewer.files/VNC-Viewer-6.19.1115-Windows-64bit.exe</p>
<figure data-type="image" tabindex="5"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191118100741.png" alt="" loading="lazy"></figure>
<p><strong>销毁虚拟机：</strong></p>
<pre><code class="language-bash">[root@node1 ~]# virsh destroy centos7-1 
Domain centos7-1 destroyed
[root@node1 ~]# virsh destroy ubuntu18.04-1 
Domain ubuntu18.04-1 destroyed
[root@node1 ~]# virsh undefine --domain centos7-1 
Domain centos7-1 has been undefined
[root@node1 ~]# virsh undefine --domain ubuntu18.04-1 
Domain ubuntu18.04-1 has been undefined
</code></pre>
<h3 id="十二-令一种方法来创建虚拟机">十二、令一种方法来创建虚拟机</h3>
<p><strong>创建系统盘</strong></p>
<pre><code class="language-bash">[root@localhost boot]# qemu-img create -f qcow2 /data/machine/CentOS7-1.qcow2 10G
Formatting '/data/machine/CentOS7-1.qcow2', fmt=qcow2 size=10737418240 encryption=off cluster_size=65536 lazy_refcounts=off 
</code></pre>
<p><strong>开始安装：</strong></p>
<pre><code class="language-bash">[root@localhost boot]# virt-install \
&gt; --name centos7-1 \
&gt; --memory 1024 \
&gt; --vcpus 1 \
&gt; --virt-type kvm \
&gt; --location=/data/iso/CentOS-7-x86_64-Minimal-1908.iso \
&gt; --disk /data/machine/CentOS7-1.qcow2 \
&gt; --network bridge=br0 \
&gt; --graphics none \
&gt; --extra-args='console=ttyS0' \
&gt; --force
</code></pre>
<p><strong>安装界面：</strong></p>
<figure data-type="image" tabindex="6"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117190801.png" alt="" loading="lazy"></figure>
<p><strong>语言设置：</strong></p>
<figure data-type="image" tabindex="7"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117190859.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="8"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117190927.png" alt="" loading="lazy"></figure>
<p><strong>时区：</strong></p>
<figure data-type="image" tabindex="9"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117191001.png" alt="" loading="lazy"></figure>
<p><strong>ntp配置：</strong></p>
<figure data-type="image" tabindex="10"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117191158.png" alt="" loading="lazy"></figure>
<p><strong>关闭kdump</strong></p>
<figure data-type="image" tabindex="11"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117191342.png" alt="" loading="lazy"></figure>
<p><strong>网络配置：开启启动</strong></p>
<figure data-type="image" tabindex="12"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117191448.png" alt="" loading="lazy"></figure>
<p><strong>root密码：</strong></p>
<figure data-type="image" tabindex="13"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117191633.png" alt="" loading="lazy"></figure>
<p><strong>b开始安装</strong></p>
<figure data-type="image" tabindex="14"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117191903.png" alt="" loading="lazy"></figure>
<p><strong>成功了：</strong></p>
<figure data-type="image" tabindex="15"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117193333.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="16"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117193540.png" alt="" loading="lazy"></figure>
<h3 id="十三-关于如何看虚拟机的ip">十三、关于如何看虚拟机的ip</h3>
<p><strong>网上大多是virsh edit [虚拟机名字]得到mac地址，然后arp看本机arp路由表</strong></p>
<p>脚本来自：https://www.v2ex.com/t/197481</p>
<pre><code class="language-bash">[root@localhost ~]# cat ping.sh 
#!/bin/bash
#BY MRCO,2015-06-10
#MODIFY 2015-06-10
#ping当前网段内在线的主机,以便产生arp记录.
subnet=`route -n|grep &quot;UG&quot; |awk '{print $2}'|sed 's/..$//g'`
for ip in $subnet.{1..253};do
{
ping -c1 $ip &gt;/dev/null 2&gt;&amp;1
}&amp;
done
#依次查找arp记录.
running_vms=`virsh list |grep running`
echo -ne &quot;共有`echo &quot;$running_vms&quot;|wc -l`个虚拟机在运行.\n&quot;
for i in `echo &quot;$running_vms&quot; | awk '{ print $2 }'`;do
mac=`virsh dumpxml $i |grep &quot;mac address&quot;|sed &quot;s/.*'\(.*\)'.*/\1/g&quot;`
ip=`arp -ne |grep &quot;$mac&quot; |awk '{printf $1}'`
printf &quot;%-30s %-30s\n&quot; $i $ip
done
</code></pre>
<figure data-type="image" tabindex="17"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191117195037.png" alt="" loading="lazy"></figure>
<h3 id="十四-虚拟机的其他操作">十四、虚拟机的其他操作</h3>
<h4 id="141查看所有虚拟机列表">14.1查看所有虚拟机列表</h4>
<pre><code class="language-bash">[root@es-2 tmp]# virsh list --all
 Id    Name                           State
----------------------------------------------------
 -     centos7-1                      shut off
</code></pre>
<h4 id="142启动虚拟机">14.2启动虚拟机</h4>
<pre><code class="language-bash">[root@es-2 tmp]# virsh start centos7-1 
Domain centos7-1 started
[root@es-2 tmp]# virsh list --all
 Id    Name                           State
----------------------------------------------------
 5     centos7-1                      running
</code></pre>
<h4 id="143关闭虚拟机">14.3关闭虚拟机</h4>
<pre><code class="language-bash">[root@es-2 tmp]# virsh shutdown centos7-1
</code></pre>
<h4 id="144设置虚拟机开机自启动">14.4设置虚拟机开机自启动</h4>
<pre><code class="language-bash">[root@es-2 tmp]# virsh autostart centos7-1
[root@es-2 ~]# virsh autostart --disable centos7-1		#开机不自动启动
</code></pre>
<h4 id="145挂起和恢复虚拟机">14.5挂起和恢复虚拟机</h4>
<pre><code class="language-bash">[root@es-2 tmp]# virsh suspend centos7-1 		#挂起虚拟机
Domain centos7-1 suspended

[root@es-2 tmp]# virsh list --all		#查看虚拟机状态
 Id    Name                           State
----------------------------------------------------
 6     centos7-1                      paused

[root@es-2 tmp]# virsh resume centos7-1 	#恢复虚拟机
Domain centos7-1 resumed

[root@es-2 tmp]# virsh list --all	#查看虚拟机状态
 Id    Name                           State
----------------------------------------------------
 6     centos7-1                      running
</code></pre>
<h4 id="146重启虚拟机">14.6重启虚拟机</h4>
<pre><code class="language-bash">[root@es-2 tmp]# virsh reboot centos7-1 
</code></pre>
<h4 id="147强制关闭虚拟机">14.7强制关闭虚拟机</h4>
<p><strong>通过这一步，可以发现virsh只不过是一个管理工具而已</strong></p>
<pre><code class="language-bash">#虚拟机仍在，仍可以virsh start启动
[root@es-2 tmp]# virsh destroy centos7-1 
#取消定义域，这样列表就看不到虚拟机了,实际上虚拟机磁盘还在
[root@es-2 tmp]# virsh dumpxml centos7-1 &gt; /tmp/centos7-1.xml	#先备份xml配置
[root@es-2 tmp]# virsh undefine centos7-1	#这样就看不到了
#再导入xml文件，重新定义
[root@es-2 tmp]# virsh define /tmp/centos7-1.xml
[root@es-2 tmp]# virsh define /tmp/centos7-1.xml 
Domain centos7-1 defined from /tmp/centos7-1.xml
[root@es-2 tmp]# virsh list --all		#查看虚拟机列表
 Id    Name                           State
----------------------------------------------------
 -     centos7-1                      shut off
[root@es-2 tmp]# virsh start centos7-1 		#启动虚拟机
Domain centos7-1 started
</code></pre>
<h4 id="148查看虚拟机网卡信息">14.8查看虚拟机网卡信息</h4>
<p><strong>可以看到mac信息</strong></p>
<pre><code class="language-bash">[root@es-2 ~]# virsh domiflist centos7-1 
Interface  Type       Source     Model       MAC
-------------------------------------------------------
vnet0      bridge     br0        virtio      52:54:00:d0:28:d9
</code></pre>
<h4 id="149查看-kvm-虚拟机磁盘信息">14.9查看 kvm 虚拟机磁盘信息</h4>
<pre><code class="language-bash">[root@es-2 ~]# virsh domblklist centos7-1 
Target     Source
------------------------------------------------
vda        /data/machine/centos7-1.qcow2
hda        -
</code></pre>
<h4 id="1410查看虚拟机配置文件信息">14.10查看虚拟机配置文件信息</h4>
<pre><code class="language-bash">[root@es-2 ~]# virsh dumpxml centos7-1 
&lt;domain type='kvm' id='8'&gt;
  &lt;name&gt;centos7-1&lt;/name&gt;
  .....
</code></pre>
<h4 id="1411查看虚拟机的基本信息">14.11查看虚拟机的基本信息</h4>
<pre><code class="language-bash">[root@es-2 ~]# virsh dominfo centos7-1 
Id:             8
Name:           centos7-1
UUID:           39bd68f5-7779-425f-9f51-6d7f9d886521
OS Type:        hvm
State:          running
CPU(s):         1
CPU time:       36.0s
Max memory:     1048576 KiB
Used memory:    1048576 KiB
Persistent:     yes
Autostart:      disable
Managed save:   no
Security model: none
Security DOI:   0
</code></pre>
<h3 id="十五-调整虚拟机磁盘大小">十五、调整虚拟机磁盘大小</h3>
<h4 id="1-当前磁盘大小">1、当前磁盘大小</h4>
<pre><code class="language-bash">[root@localhost ~]# lsblk 
NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sr0              11:0    1 1024M  0 rom  
vda             252:0    0  100G  0 disk 
├─vda1          252:1    0  512M  0 part /boot
└─vda2          252:2    0   72G  0 part 
  ├─centos-root 253:0    0   20G  0 lvm  /
  ├─centos-swap 253:1    0    2G  0 lvm  [SWAP]
  └─centos-data 253:2    0   50G  0 lvm  /data
</code></pre>
<h4 id="2-查看虚拟机磁盘位置">2、查看虚拟机磁盘位置</h4>
<pre><code class="language-bash">[root@es-2 ~]# virsh domblklist centos7-1 
Target     Source
------------------------------------------------
vda        /data/machine/centos7-1.qcow2
hda        -
</code></pre>
<h4 id="3-查看磁盘信息">3、查看磁盘信息</h4>
<pre><code class="language-bash">[root@es-2 ~]# qemu-img info /data/machine/centos7-1.qcow2
image: /data/machine/centos7-1.qcow2
file format: qcow2
virtual size: 100G (107374182400 bytes)
disk size: 1.9G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
[root@es-2 ~]# du -sh /data/machine/centos7-1.qcow2
2.0G	/data/machine/centos7-1.qcow2
[root@es-2 ~]# ls -lh /data/machine/centos7-1.qcow2
-rw-r--r-- 1 qemu qemu 2.0G Nov 18 13:34 /data/machine/centos7-1.qcow2
</code></pre>
<h4 id="4-给磁盘加10g">4、给磁盘加10G</h4>
<pre><code class="language-bash">[root@es-2 ~]# qemu-img info /data/machine/centos7-1.qcow2
image: /data/machine/centos7-1.qcow2
file format: qcow2
virtual size: 110G (118111600640 bytes)
disk size: 1.9G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
</code></pre>
<h4 id="5-重启虚拟机查看">5、重启虚拟机查看</h4>
<p>下面实验证明了调整磁盘一定要关机后操作，然后启动</p>
<pre><code class="language-bash">[root@es-2 ~]# virsh reboot centos7-1
</code></pre>
<pre><code class="language-bash">#没有生效
磁盘 /dev/vda：107.4 GB, 107374182400 字节，209715200 个扇区
[root@localhost ~]# lsblk
NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sr0              11:0    1 1024M  0 rom  
vda             252:0    0  100G  0 disk 
├─vda1          252:1    0  512M  0 part /boot
└─vda2          252:2    0   72G  0 part 
  ├─centos-root 253:0    0   20G  0 lvm  /
  ├─centos-swap 253:1    0    2G  0 lvm  [SWAP]
  └─centos-data 253:2    0   50G  0 lvm  /data
</code></pre>
<p><strong>再次调整：</strong></p>
<figure data-type="image" tabindex="18"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191119135836.png" alt="" loading="lazy"></figure>
<p><strong>vrish reboot还是不行，先关机，再开机就好了</strong></p>
<figure data-type="image" tabindex="19"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191119140308.png" alt="" loading="lazy"></figure>
<h3 id="十六-调整虚拟机内存">十六、调整虚拟机内存</h3>
<p><strong>当前虚拟机内存</strong></p>
<pre><code class="language-bash">[root@es-2 ~]# virsh dominfo centos7-1 
Id:             9
Name:           centos7-1
UUID:           39bd68f5-7779-425f-9f51-6d7f9d886521
OS Type:        hvm
State:          running
CPU(s):         1
CPU time:       23.6s
Max memory:     1048576 KiB
Used memory:    1048576 KiB
Persistent:     yes
Autostart:      disable
Managed save:   no
Security model: none
Security DOI:   0
</code></pre>
<p><strong>调整</strong></p>
<pre><code class="language-bash">[root@es-2 ~]# virsh shutdown centos7-1 
[root@es-2 ~]# virsh setmaxmem centos7-1 2G		#关机后设置最大内存
[root@es-2 ~]# virsh start centos7-1 		
[root@es-2 ~]# virsh setmem centos7-1 2G		#开机后设置虚拟机内存
</code></pre>
<p><strong>调整后</strong></p>
<pre><code class="language-bash">[root@es-2 ~]# virsh dominfo centos7-1 
Id:             10
Name:           centos7-1
UUID:           39bd68f5-7779-425f-9f51-6d7f9d886521
OS Type:        hvm
State:          running
CPU(s):         1
CPU time:       17.9s
Max memory:     2097152 KiB
Used memory:    2097152 KiB
Persistent:     yes
Autostart:      disable
Managed save:   no
Security model: none
Security DOI:   0
#进入虚拟机查看
[root@localhost ~]# free -h
              total        used        free      shared  buff/cache   available
Mem:           2.0G         87M        1.8G        8.5M         91M        1.7G
Swap:          2.0G          0B        2.0G
</code></pre>
<h3 id="十七-使用xml文件创建虚拟机">十七、使用xml文件创建虚拟机</h3>
<h4 id="先传一个模版虚拟机"><strong>先传一个模版虚拟机</strong></h4>
<pre><code class="language-bash">[root@kibana ~]# scp /opt/centos7-init.qcow2 172.18.3.139:/data/machine/centos7-2.qcow2
</code></pre>
<h4 id="编写配置文件大佬给的暂时不会改"><strong>编写配置文件（大佬给的，暂时不会改）</strong></h4>
<pre><code class="language-xml">&lt;domain type='kvm'&gt;
  &lt;name&gt;centos7-2&lt;/name&gt;
  &lt;memory unit='GiB'&gt;1&lt;/memory&gt;
  &lt;currentMemory unit='GiB'&gt;1&lt;/currentMemory&gt;
  &lt;vcpu placement='static'&gt;2&lt;/vcpu&gt;
  &lt;sysinfo type='smbios'&gt;
    &lt;system&gt;
      &lt;entry name='manufacturer'&gt;test&lt;/entry&gt;
    &lt;/system&gt;
  &lt;/sysinfo&gt;
  &lt;os&gt;
    &lt;type arch='x86_64' machine='pc'&gt;hvm&lt;/type&gt;
    &lt;boot dev='hd'/&gt;
    &lt;bootmenu enable='yes'/&gt;
    &lt;smbios mode='sysinfo'/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;pae/&gt;
  &lt;/features&gt;
  &lt;clock offset='utc'/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='qcow2' cache='writeback'/&gt;
      &lt;source file='/data/machine/centos7-2.qcow2'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
    &lt;/disk&gt;
    &lt;disk type='file' device='cdrom'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;source file='/data/iso/CentOS-7-x86_64-Minimal-1908.iso'/&gt;
      &lt;target dev='hdb' bus='ide'/&gt;
    &lt;readonly/&gt;
    &lt;/disk&gt;
    &lt;controller type='virtio-serial' index='0'&gt;
    &lt;/controller&gt;
    &lt;controller type='usb' index='0' model='piix3-uhci'&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='0' model='pci-root'/&gt;
    &lt;serial type='pty'&gt;
      &lt;target type='isa-serial' port='0'&gt;
        &lt;model name='isa-serial'/&gt;
      &lt;/target&gt;
    &lt;/serial&gt;
    &lt;console type='pty'&gt;
      &lt;target type='serial' port='0'/&gt;
    &lt;/console&gt;
    &lt;input type='tablet' bus='usb'&gt;
    &lt;/input&gt;
    &lt;input type='mouse' bus='ps2'/&gt;
    &lt;input type='keyboard' bus='ps2'/&gt;
    &lt;graphics type='vnc' port='-1' autoport='yes' listen='0.0.0.0'&gt;
    &lt;/graphics&gt;
    &lt;video&gt;
      &lt;model type='cirrus' vram='16384' heads='1' primary='yes'/&gt;
    &lt;/video&gt;
    &lt;memballoon model='virtio'&gt;
      &lt;stats period='10'/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</code></pre>
<h4 id="使用配置文件定义虚拟机然后开机"><strong>使用配置文件定义虚拟机，然后开机</strong></h4>
<pre><code class="language-bash">[root@es-2 ~]# virsh define centos7-2.xml 
Domain centos7-2 defined from centos7-2.xml

[root@es-2 ~]# virsh list --all		#定义之后就有了
 Id    Name                           State
----------------------------------------------------
 10    centos7-1                      running
 -     centos7-2                      shut off

[root@es-2 ~]# virsh start centos7-2	#开机
Domain centos7-2 started
</code></pre>
<h4 id="连接虚拟机试试">连接虚拟机试试</h4>
<pre><code class="language-bash">[root@es-2 ~]# ss -ltn | grep :59
LISTEN     0      1            *:5900                     *:*                  
LISTEN     0      1            *:5901                     *:*  
</code></pre>
<p><strong>有点小问题，没有IP</strong></p>
<figure data-type="image" tabindex="20"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191119142028.png" alt="" loading="lazy"></figure>
<p><strong>修改配置文件，加上mac地址(mac地址还不能随便填，网上生成的不能用，我就照着其他的mac改了几位)</strong></p>
<pre><code class="language-xml">&lt;domain type='kvm'&gt;
  &lt;name&gt;centos7-2&lt;/name&gt;
  &lt;memory unit='GiB'&gt;1&lt;/memory&gt;
  &lt;currentMemory unit='GiB'&gt;1&lt;/currentMemory&gt;
  &lt;vcpu placement='static'&gt;2&lt;/vcpu&gt;
  &lt;sysinfo type='smbios'&gt;
    &lt;system&gt;
      &lt;entry name='manufacturer'&gt;test&lt;/entry&gt;
    &lt;/system&gt;
  &lt;/sysinfo&gt;
  &lt;os&gt;
    &lt;type arch='x86_64' machine='pc'&gt;hvm&lt;/type&gt;
    &lt;boot dev='hd'/&gt;
    &lt;bootmenu enable='yes'/&gt;
    &lt;smbios mode='sysinfo'/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;pae/&gt;
  &lt;/features&gt;
  &lt;clock offset='utc'/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='qcow2' cache='writeback'/&gt;
      &lt;source file='/data/machine/centos7-2.qcow2'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
    &lt;/disk&gt;
    &lt;disk type='file' device='cdrom'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;source file='/data/iso/CentOS-7-x86_64-Minimal-1908.iso'/&gt;
      &lt;target dev='hdb' bus='ide'/&gt;
    &lt;readonly/&gt;
    &lt;/disk&gt;
    &lt;controller type='virtio-serial' index='0'&gt;
    &lt;/controller&gt;
    &lt;controller type='usb' index='0' model='piix3-uhci'&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='0' model='pci-root'/&gt;
    &lt;serial type='pty'&gt;
      &lt;target type='isa-serial' port='0'&gt;
        &lt;model name='isa-serial'/&gt;
      &lt;/target&gt;
    &lt;/serial&gt;
    &lt;interface type='bridge'&gt;
      &lt;mac address='52:C7:CE:41:D5:EA'/&gt;
      &lt;source bridge='br0'/&gt;
      &lt;target dev='vnet0'/&gt;
      &lt;model type='virtio'/&gt;
      &lt;alias name='net0'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;
    &lt;/interface&gt;
    &lt;console type='pty'&gt;
      &lt;target type='serial' port='0'/&gt;
    &lt;/console&gt;
    &lt;input type='tablet' bus='usb'&gt;
    &lt;/input&gt;
    &lt;input type='mouse' bus='ps2'/&gt;
    &lt;input type='keyboard' bus='ps2'/&gt;
    &lt;graphics type='vnc' port='-1' autoport='yes' listen='0.0.0.0'&gt;
    &lt;/graphics&gt;
    &lt;video&gt;
      &lt;model type='cirrus' vram='16384' heads='1' primary='yes'/&gt;
    &lt;/video&gt;
    &lt;memballoon model='virtio'&gt;
      &lt;stats period='10'/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</code></pre>
<figure data-type="image" tabindex="21"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191119143958.png" alt="" loading="lazy"></figure>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kill0es.github.io/tag/BNyw-poTA/" class="tag">
                    kvm
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://kill0es.github.io/iFS2Gihr6/">
                  <h3 class="post-title">
                     kvm实战（二）
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>






  </body>
</html>
