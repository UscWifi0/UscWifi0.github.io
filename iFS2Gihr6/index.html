<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title> kvm实战（二） | quansen88.cn</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://kill0es.github.io/favicon.ico?v=1623995355721">
<link rel="stylesheet" href="https://kill0es.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="kvm实战（二）
一、安装相关软件
yum install qemu-kvm libvirt virt-install -y

二、启动服务
systemctl start libvirtd &amp;&amp; systemctl ena..." />
    <meta name="keywords" content="kvm" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://kill0es.github.io">
        <img src="https://kill0es.github.io/images/avatar.png?v=1623995355721" class="site-logo">
        <h1 class="site-title">quansen88.cn</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      linux运维
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/kill0es/" target="_blank">kill0es</a> | <a class="rss" href="https://kill0es.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title"> kvm实战（二）</h2>
            <div class="post-date">2021-05-04</div>
            
              <div class="feature-container" style="background-image: url('https://www.linux.org/images/logo.png')">
              </div>
            
            <div class="post-content" v-pre>
              <h1 id="kvm实战二">kvm实战（二）</h1>
<h3 id="一-安装相关软件">一、安装相关软件</h3>
<pre><code class="language-bash">yum install qemu-kvm libvirt virt-install -y
</code></pre>
<h3 id="二-启动服务">二、启动服务</h3>
<pre><code class="language-bash">systemctl start libvirtd &amp;&amp; systemctl enable libvirtd
</code></pre>
<h3 id="三-修改网卡配置">三、修改网卡配置</h3>
<pre><code class="language-bash">[root@es-2 network-scripts]# cat ifcfg-ens33 
# Generated by dracut initrd
NAME=&quot;eth0&quot;
ONBOOT=yes
BOOTPROTO=static
TYPE=Ethernet
BRIDGE=br0
DNS1=114.114.114.114
[root@es-2 network-scripts]# cat ifcfg-br0 
NAME=&quot;br0&quot;
DEVICE=br0
ONBOOT=yes
BOOTPROTO=static
TYPE=Bridge
IPADDR=172.18.3.139
NETMASK=255.255.0.0
GATEWAY=172.18.0.1
DNS1=114.114.114.114
[root@es-2 network-scripts]# systemctl restart network
</code></pre>
<h3 id="四-删除默认网卡网络">四、删除默认网卡，网络</h3>
<pre><code class="language-bash">virsh net-undefine default
virsh net-autostart --disable default
virsh net-destroy default
ip link set virbr0-nic down
ip link delete virbr0-nic
ip link delete virbr0
</code></pre>
<h3 id="五-镜像">五、镜像</h3>
<pre><code class="language-bash">mkdir /data/{iso,machine} -p
cd /data/iso/
wget https://mirrors.huaweicloud.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1908.iso
</code></pre>
<h3 id="六-创建磁盘">六、创建磁盘</h3>
<pre><code class="language-bash">qemu-img create -f qcow2  /data/machine/centos7-1.qcow2 100G
</code></pre>
<h3 id="七-virt-install创建虚拟机">七、virt-install创建虚拟机</h3>
<pre><code class="language-bash">virt-install \
--name centos7-1 \
--memory 1024 \
--vcpus 1 \
--virt-type kvm \
--cdrom /data/iso/CentOS-7-x86_64-Minimal-1908.iso \
--disk /data/machine/centos7-1.qcow2 \
--network bridge=br0 \
--graphics vnc,listen=0.0.0.0 \
--noautoconsole
</code></pre>
<pre><code class="language-bash">[root@es-2 ~]# ss -ltn
State      Recv-Q Send-Q                      Local Address:Port                                     Peer Address:Port              
LISTEN     0      1                                       *:5900                                                *:*                  
LISTEN     0      128                                     *:111                                                 *:*                  
LISTEN     0      128                                     *:22                                                  *:*                  
LISTEN     0      100                             127.0.0.1:25                                                  *:*                  
LISTEN     0      128                                    :::111                                                :::*                  
LISTEN     0      128                                    :::22                                                 :::*                  
LISTEN     0      100                                   ::1:25                                                 :::*        
</code></pre>
<h3 id="vnc连这里遇到了一个坑建议去官网下载vnc-viewer连">vnc连(这里遇到了一个坑，建议去官网下载vnc viewer连)</h3>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191118100741.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/52cto/PictureGo/master/img/20191118101035.png" alt="" loading="lazy"></figure>
<h3 id="八-第一次备份可以不用">八、第一次备份（可以不用）</h3>
<pre><code class="language-bash">[root@es-2 machine]# du -sh centos7-1.qcow2 
3.1G	centos7-1.qcow2
[root@es-2 machine]# scp centos7-1.qcow2 172.18.4.4:/opt/
</code></pre>
<h3 id="九-基本优化">九、基本优化</h3>
<pre><code class="language-bash">#重新开机
[root@es-2 machine]# virsh start --domain centos7-1 
</code></pre>
<pre><code class="language-bash">[root@localhost ~]# cat reset4.0-test.sh 
#!/bin/bash
#**************************************************************
#Author:                     28
#Date:                       2019-08-01
#FileName:                   reset.sh
#URL:                        https://quansen88.cn
#Description:                The test script
#Copyright (C):              2019 Copyright ©  站点名称  版权所有
#************************************************************
#set -e
RED=&quot;\033[0;31m&quot;
GREEN=&quot;\033[0;32m&quot;
NO_COLOR=&quot;\033[0m&quot;

# 修改别名
modify_alias() {
cat &gt;&gt; ~/.bashrc &lt;&lt;EOF
alias cdnet='cd /etc/sysconfig/network-scripts/'
alias editnet='vim /etc/sysconfig/network-scripts/ifcfg-ens33'
alias rm='rm -i'
alias scandisk=&quot;echo ' - - - ' &gt; /sys/class/scsi_host/host0/scan;echo ' - - - ' &gt; /sys/class/scsi_host/host1/scan;echo ' - - - ' &gt; /sys/class/scsi_host/host2/scan&quot;
EOF
}

# 修改命令提示符
modify_PS1() {
    echo 'PS1=&quot;\[\e[1;34m\][\u@\h \W]\\$\[\e[0m\] &quot;' &gt;&gt; /etc/profile.d/env.sh
}

# 安装基本软件
install_software() {
    yum install   gcc gcc-c++ glibc glibc-devel pcre pcre-devel openssl  openssl-devel systemd-devel zlib-devel  vim lrzsz tree screen  lsof tcpdump wget  ntpdate net-tools iotop bc  zip unzip nfs-utils -y
}

# 替换yum源
replace_yum() {
    #wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
    curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
    sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo
    #wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
    curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
    yum makecache
}

# vim
# vimrc复制过来
modify_vimrc() {
cat &gt; ~/.vimrc &lt;&lt;EOF
set ignorecase
set cursorline
set autoindent
set ai
autocmd BufNewFile *.sh exec &quot;:call SetTitle()&quot;

func SetTitle()
        if expand(&quot;%:e&quot;) == 'sh'
        call setline(1,&quot;#!/bin/bash&quot;)
        call setline(2,&quot;#**************************************************************&quot;)
        call setline(3,&quot;#Author:                     Linus&quot;)
        call setline(5,&quot;#Date:                       &quot;.strftime(&quot;%Y-%m-%d&quot;))
        call setline(6,&quot;#FileName:                   &quot;.expand(&quot;%&quot;))
        call setline(7,&quot;#URL:                        https://quansen88.cn&quot;)
        call setline(8,&quot;#Description:                Initialize the new server&quot;)         
        call setline(9,&quot;#Copyright (C):              &quot;.strftime(&quot;%Y&quot;).&quot; Copyright ©  站点名称  版权所有&quot;)
        call setline(10,&quot;#************************************************************&quot;)
        call setline(11,&quot;&quot;)
        endif
endfunc
autocmd BufNewFile * normal G
EOF
}

# 关闭selinux和firewalld
iptables_selinux_stop() {
    sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
    setenforce 0

    systemctl stop firewalld
    systemctl disable firewalld
}

# 判断是不是root
judge_root() {
    [ $(id -u) != &quot;0&quot; ] &amp;&amp; { echo -e &quot;${RED}Error:${NO_COLOR} You must be root to run this script.&quot;; exit 1; }   
}

# 判断是不是CentOS7
Check_release() {
    if [ -f /etc/redhat-release ];then
        release=&quot;centos&quot;
        version=`sed -r 's/.* ([0-9]+)\..*/\1/' /etc/redhat-release`
    if [ &quot;$version&quot; = &quot;7&quot; ];then
        echo &quot;Current release: CentOS7.&quot;
    else {
        echo -e &quot;[${RED}Error${NO_COLOR}] This script can only be running on CentOS7.&quot;
        exit 1
    }
    fi
    else {
        echo -e &quot;[${RED}Error${NO_COLOR}] This script can only be running on CentOS7.&quot;
    exit 1
    }
    fi
}

########################时区调整########################
timezone_adjust(){
    ln -sf  /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
}

#修改网卡为eth0
modify_eth_card() {
   ip a | grep -q eth0
   if [ &quot;$?&quot; -eq 1 ];then
       sed -ri '/^GRUB_CMDLINE/s/(.*)&quot;/\1 net.ifnames=0&quot;/' /etc/default/grub
       grub2-mkconfig -o /boot/grub2/grub.cfg
   fi
   #sed -i &quot;/UUID/d&quot; /etc/sysconfig/network-scripts/ifcfg-ens33
   #sed -i &quot;/DEVICE/d&quot; /etc/sysconfig/network-scripts/ifcfg-ens33
   #echo &quot;DNS1=114.114.114.114&quot; &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-ens33
   rm -f /etc/sysconfig/network-scripts/ifcfg-ens33
   cat &gt; /etc/sysconfig/network-scripts/ifcfg-eth0 &lt;&lt;EOF
NAME=&quot;eth0&quot;
ONBOOT=yes
NETBOOT=yes
BOOTPROTO=dhcp
TYPE=Ethernet
DNS1=114.114.114.114
EOF
}

#自动补全
bash_completion() {
    yum install bash-completion -y
    source /usr/share/bash-completion/bash_completion
}

#时间同步
time_sync(){
    yum install chrony -y
    sed '/^server/s/^/#/' /etc/chrony.conf -i
    sed '1a server ntp.aliyun.com iburst' /etc/chrony.conf -i
    sed '1a server 0.cn.pool.ntp.org iburst' /etc/chrony.conf -i
    sed '1a server ntp1.aliyun.com iburst' /etc/chrony.conf -i
    systemctl restart chronyd
    systemctl enable chronyd
    # echo '*/30 * * * * /usr/sbin/ntpdate ntp.aliyun.com &amp;&gt;/dev/null' &gt;&gt; /var/spool/cron/root
}

#ssh调优
ssh_adjust(){
    cp /etc/ssh/sshd_config{,_bak}
    sed '/^GSSAPIAuthentication/d' /etc/ssh/sshd_config -i
    sed '/^UseDNS/d' /etc/ssh/sshd_config -i
    echo &quot;GSSAPIAuthentication no&quot; &gt;&gt; /etc/ssh/sshd_config
    echo &quot;UseDNS no&quot; &gt;&gt; /etc/ssh/sshd_config
    systemctl restart sshd
}

#最大文件打开数
limits_tune(){
    echo '
*   soft nofile 128000
*   hard nofile 256000

root soft nofile 128000
root hard nofile 256000
' &gt;&gt; /etc/security/limits.conf
}


main() {
    judge_root
    Check_release
    replace_yum
    install_software
    iptables_selinux_stop
    modify_alias
    modify_vimrc
    timezone_adjust
    time_sync
    limits_tune
    ssh_adjust 
    modify_PS1
    modify_eth_card
    bash_completion
}

main
[root@localhost ~]# bash reset4.0-test.sh 
</code></pre>
<h3 id="十-第二次备份可以作为模版用了">十、第二次备份（可以作为模版用了）</h3>
<pre><code class="language-bash">[root@es-2 machine]# scp centos7-1.qcow2 172.18.4.4:/opt/centos7-init.qcow2
</code></pre>
<h3 id="十一-使用模版机克隆">十一、使用模版机克隆</h3>
<h4 id="1-准备xml文件">1、准备xml文件</h4>
<p>需要改的地方:name，memory，currentMemory，vcpu，source file（磁盘位置，镜像那也可以改下），mac address（不要随机生成，改几位就行）</p>
<p>mac地址也可以用vmware生成</p>
<pre><code class="language-xml">[root@es-2 ~]# cat centos7-2.xml 
&lt;domain type='kvm'&gt;
  &lt;name&gt;centos7-2&lt;/name&gt;
  &lt;memory unit='GiB'&gt;1&lt;/memory&gt;
  &lt;currentMemory unit='GiB'&gt;1&lt;/currentMemory&gt;
  &lt;vcpu placement='static'&gt;2&lt;/vcpu&gt;
  &lt;sysinfo type='smbios'&gt;
    &lt;system&gt;
      &lt;entry name='manufacturer'&gt;test&lt;/entry&gt;
    &lt;/system&gt;
  &lt;/sysinfo&gt;
  &lt;os&gt;
    &lt;type arch='x86_64' machine='pc'&gt;hvm&lt;/type&gt;
    &lt;boot dev='hd'/&gt;
    &lt;bootmenu enable='yes'/&gt;
    &lt;smbios mode='sysinfo'/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;pae/&gt;
  &lt;/features&gt;
  &lt;clock offset='utc'/&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='qcow2' cache='writeback'/&gt;
      &lt;source file='/data/machine/centos7-2.qcow2'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
    &lt;/disk&gt;
    &lt;disk type='file' device='cdrom'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;source file='/data/iso/CentOS-7-x86_64-Minimal-1908.iso'/&gt;
      &lt;target dev='hdb' bus='ide'/&gt;
    &lt;readonly/&gt;
    &lt;/disk&gt;
    &lt;controller type='virtio-serial' index='0'&gt;
    &lt;/controller&gt;
    &lt;controller type='usb' index='0' model='piix3-uhci'&gt;
    &lt;/controller&gt;
    &lt;controller type='pci' index='0' model='pci-root'/&gt;
    &lt;serial type='pty'&gt;
      &lt;target type='isa-serial' port='0'&gt;
        &lt;model name='isa-serial'/&gt;
      &lt;/target&gt;
    &lt;/serial&gt;
    &lt;interface type='bridge'&gt;
      &lt;mac address='52:C7:CE:41:D5:EA'/&gt;
      &lt;source bridge='br0'/&gt;
      &lt;target dev='vnet0'/&gt;
      &lt;model type='virtio'/&gt;
      &lt;alias name='net0'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;
    &lt;/interface&gt;
    &lt;console type='pty'&gt;
      &lt;target type='serial' port='0'/&gt;
    &lt;/console&gt;
    &lt;input type='tablet' bus='usb'&gt;
    &lt;/input&gt;
    &lt;input type='mouse' bus='ps2'/&gt;
    &lt;input type='keyboard' bus='ps2'/&gt;
    &lt;graphics type='vnc' port='-1' autoport='yes' listen='0.0.0.0'&gt;
    &lt;/graphics&gt;
    &lt;video&gt;
      &lt;model type='cirrus' vram='16384' heads='1' primary='yes'/&gt;
    &lt;/video&gt;
    &lt;memballoon model='virtio'&gt;
      &lt;stats period='10'/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</code></pre>
<h4 id="2-按照配置文件把qcow2文件和镜像放到对应目录">2、按照配置文件把qcow2文件和镜像放到对应目录</h4>
<pre><code class="language-bash">[root@es-2 ~]# tree -C /data/
/data/
├── image
├── iso
│   └── CentOS-7-x86_64-Minimal-1908.iso
└── machine
    ├── centos7-1.qcow2
    └── centos7-2.qcow2
</code></pre>
<h4 id="3-导入xml文件启动">3、导入xml文件，启动</h4>
<pre><code class="language-bash">virsh define centos7-2.xml
virsh start centos7-2
</code></pre>
<h4 id="4-关于mac地址">4、关于mac地址</h4>
<p>参考：https://www.douban.com/note/733401994/</p>
<p>MAC（Media Access Control，介质访问控制）地址，或称为MAC位址、硬件地址，用来定义网络设备的位置。MAC集成在网卡，由48bit的2进制的数字组成，0~23位数字叫作组织唯一标志符（organizationally unique，是识别局域网节点的标识）。24~47位是由厂家自己分配，其中第48位是组播地址标志位。网卡的物理地址通常是由网卡生产厂家写入网卡的EPROM芯片中，芯片中的数据可以通过程序进行擦写，它存储的是传输数据时真正赖以标识发出数据的电脑和接收数据的主机的地址。也就是说，在网络底层的物理传输过程中，数据传输是通过物理地址来识别主机的，它一定是全球唯一的。</p>
<pre><code class="language-bash">error: unsupported configuration: Unable to use MAC address starting with reserved value 0xFE - 'fe:b0:75:50:34:c2' -
</code></pre>
<pre><code class="language-bash">error: XML error: expected unicast mac address, found multicast '67:f7:bc:25:42:cf'
</code></pre>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://kill0es.github.io/tag/BNyw-poTA/" class="tag">
                    kvm
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://kill0es.github.io/jUw_76RJ6/">
                  <h3 class="post-title">
                     EFK教程 - EFK快速入门指南
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>






  </body>
</html>
